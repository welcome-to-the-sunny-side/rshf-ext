(()=>{"use strict";var e,t={3:(e,t,a)=>{const s={group:"",showAlternativeRating:!0,noGroupRatingStyle:"opacity",maxReplacementsPerPage:2e3,cacheThresholdMinutes:30},r="settings",n="cache";class c{static async fetchRatings(e,t){return console.log(`Fetching ratings for ${e.length} users in group "${t}"`),await new Promise((e=>setTimeout(e,500))),{users:e.map((e=>({username:e,rating:Math.random()<.8?Math.floor(4e3*Math.random()):-1})))}}static getCurrentUser(){return"TestUser"}}var i=a(815),o=a.n(i);class g{static async getUsernamesToRequest(e){const t=await this.getSettings(),a=await this.getCache(),s=Date.now(),r=60*t.cacheThresholdMinutes*1e3;return e.filter((e=>{const t=a[e];return!t||s-t.time>r}))}static async updateCache(e){const t=await this.getCache(),a=Date.now();Object.entries(e).forEach((([e,s])=>{t[e]={rating:s,time:a}})),await o().storage.local.set({[n]:t})}static async getRatings(e){const t=await this.getSettings(),a=await this.getCache(),s=await this.getUsernamesToRequest(e);if(s.length>0){const a=await c.fetchRatings(s,t.group),r={};a.users.forEach((e=>{r[e.username]=e.rating})),await this.updateCache(r);const n=await this.getCache();return this.getCachedRatings(e,n)}return this.getCachedRatings(e,a)}static getCachedRatings(e,t){const a={};return e.forEach((e=>{const s=t[e];a[e]=s?s.rating:-1})),a}static async getCache(){return(await o().storage.local.get(n))[n]||{}}static async clearCache(){await o().storage.local.set({[n]:{}})}static async getSettings(){const e=await o().storage.local.get(r);return{...s,...e[r]}}static async saveSettings(e){const t={...await this.getSettings(),...e};await o().storage.local.set({[r]:t})}}console.log("[RSHF-EXT] Background script initialized!"),self.postMessage({type:"BACKGROUND_READY"}),o().runtime.onMessage.addListener((async(e,t)=>{console.log("[RSHF-EXT] Background script received message:",e);try{switch(e.type){case"GET_RATINGS":const t=e.usernames,a=await g.getSettings(),s=t.slice(0,a.maxReplacementsPerPage);return await g.getRatings(s);case"CLEAR_CACHE":return await g.clearCache(),{success:!0};case"GET_SETTINGS":return await g.getSettings();case"SAVE_SETTINGS":return await g.saveSettings(e.settings),{success:!0}}return!1}catch(e){return console.error("[RSHF-EXT] Background script error:",e),{error:e.message||"Unknown error"}}})),o().alarms.create("cleanupCache",{periodInMinutes:1440}),o().alarms.onAlarm.addListener((async e=>{if("cleanupCache"===e.name){console.log("Running scheduled cache cleanup");const e=await g.getCache(),t=await g.getSettings(),a=Date.now(),s=60*t.cacheThresholdMinutes*1e3*7,r={...e};let n=0;Object.entries(e).forEach((([e,t])=>{a-t.time>s&&(delete r[e],n++)})),n>0&&(await o().storage.local.set({cache:r}),console.log(`Removed ${n} old cache entries`))}}))}},a={};function s(e){var r=a[e];if(void 0!==r)return r.exports;var n=a[e]={exports:{}};return t[e].call(n.exports,n,n.exports,s),n.exports}s.m=t,e=[],s.O=(t,a,r,n)=>{if(!a){var c=1/0;for(l=0;l<e.length;l++){for(var[a,r,n]=e[l],i=!0,o=0;o<a.length;o++)(!1&n||c>=n)&&Object.keys(s.O).every((e=>s.O[e](a[o])))?a.splice(o--,1):(i=!1,n<c&&(c=n));if(i){e.splice(l--,1);var g=r();void 0!==g&&(t=g)}}return t}n=n||0;for(var l=e.length;l>0&&e[l-1][2]>n;l--)e[l]=e[l-1];e[l]=[a,r,n]},s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(var a in t)s.o(t,a)&&!s.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e={471:0};s.O.j=t=>0===e[t];var t=(t,a)=>{var r,n,[c,i,o]=a,g=0;if(c.some((t=>0!==e[t]))){for(r in i)s.o(i,r)&&(s.m[r]=i[r]);if(o)var l=o(s)}for(t&&t(a);g<c.length;g++)n=c[g],s.o(e,n)&&e[n]&&e[n][0](),e[n]=0;return s.O(l)},a=self.webpackChunkrshf_ext=self.webpackChunkrshf_ext||[];a.forEach(t.bind(null,0)),a.push=t.bind(null,a.push.bind(a))})();var r=s.O(void 0,[815],(()=>s(3)));r=s.O(r)})();